<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾åƒç°åº¦åˆ†æå·¥å…· - ä¿®å¤ç‰ˆ</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 25px;
        }

        .left-panel {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            flex: 1;
            min-width: 400px;
            background-color: #f9fafc;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .control-section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f2f5;
            font-weight: 600;
        }

        .upload-area {
            border: 2px dashed #6a11cb;
            border-radius: 8px;
            padding: 30px 20px;
            text-align: center;
            background-color: #f9f6ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background-color: #f0ebff;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 3rem;
            color: #6a11cb;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #888;
            font-size: 0.9rem;
        }

        #imageInput {
            display: none;
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f0f2f5;
            border: 2px solid #e1e5eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #imageCanvas {
            max-width: 100%;
            max-height: 100%;
            cursor: crosshair;
            display: block;
        }

        .image-placeholder {
            color: #aaa;
            font-size: 1.2rem;
            text-align: center;
            padding: 30px;
        }

        .point-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d9e6;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 140px;
        }

        .primary-btn {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }

        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.3);
        }

        .secondary-btn {
            background-color: #f0f2f5;
            color: #555;
        }

        .secondary-btn:hover {
            background-color: #e1e5eb;
        }

        .warning-btn {
            background-color: #ff6b6b;
            color: white;
        }

        .warning-btn:hover {
            background-color: #ff5252;
        }

        .results-section {
            margin-top: 25px;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stats-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }

        .stat-box {
            flex: 1;
            min-width: 150px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #6a11cb;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #777;
        }

        .points-table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            background-color: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #444;
            border-bottom: 2px solid #eaeaea;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .point-id {
            font-weight: 600;
            color: #333;
        }

        .point-coords {
            color: #666;
            font-family: monospace;
        }

        .point-gray {
            font-weight: 600;
        }

        .point-diff {
            font-weight: 600;
        }

        .in-range {
            color: #27ae60;
        }

        .out-of-range {
            color: #e74c3c;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }

        .debug-info {
            font-size: 0.85rem;
            color: #666;
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
        }

        @media (max-width: 1100px) {
            .main-content {
                flex-direction: column;
            }

            .left-panel, .right-panel {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .point-controls {
                flex-direction: column;
            }

            .stat-box {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å›¾åƒç°åº¦åˆ†æå·¥å…· - ä¿®å¤ç‰ˆ</h1>
            <p class="subtitle">ä¿®å¤äº†ç‚¹å‡»ä½ç½®å’Œç°åº¦è®¡ç®—é—®é¢˜ï¼Œç°åœ¨å¯ä»¥å‡†ç¡®é€‰æ‹©ç‚¹å¹¶è®¡ç®—ç°åº¦å€¼</p>
        </header>

        <div class="main-content">
            <div class="left-panel">
                <div class="control-section">
                    <h2 class="section-title">1. ä¸Šä¼ å›¾åƒ</h2>
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾åƒæ–‡ä»¶æˆ–æ‹–æ”¾å›¾åƒåˆ°æ­¤å¤„</div>
                        <div class="upload-hint">æ”¯æŒ JPG, PNG, BMP, GIF æ ¼å¼</div>
                        <input type="file" id="imageInput" accept="image/*">
                    </div>
                </div>

                <div class="control-section">
                    <h2 class="section-title">2. é€‰æ‹©åˆ†æç‚¹</h2>
                    <div class="image-container">
                        <canvas id="imageCanvas"></canvas>
                        <div id="imagePlaceholder" class="image-placeholder">
                            è¯·ä¸Šä¼ å›¾åƒä»¥å¼€å§‹åˆ†æ
                        </div>
                    </div>

                    <div class="debug-info" id="debugInfo">
                        ç”»å¸ƒå°ºå¯¸: 0Ã—0 | å›¾åƒåŸå§‹å°ºå¯¸: 0Ã—0 | ç¼©æ”¾æ¯”ä¾‹: 1.00
                    </div>

                    <div class="point-controls">
                        <div class="control-group">
                            <label for="sampleRadius">é‡‡æ ·åŠå¾„ (åƒç´ )</label>
                            <input type="number" id="sampleRadius" min="0" max="10" value="0">
                            <div style="font-size: 0.85rem; color: #777; margin-top: 5px;">0è¡¨ç¤ºåªé‡‡æ ·å•ä¸ªåƒç´ ï¼Œå¤§äº0è¡¨ç¤ºé‡‡æ ·å‘¨å›´åŒºåŸŸ</div>
                        </div>

                        <div class="control-group">
                            <label for="threshold">æµ®åŠ¨é˜ˆå€¼ (%)</label>
                            <input type="number" id="threshold" min="1" max="100" value="10">
                            <div style="font-size: 0.85rem; color: #777; margin-top: 5px;">è®¾ç½®ç°åº¦å€¼æµ®åŠ¨å·®å¼‚çš„é˜ˆå€¼</div>
                        </div>
                    </div>

                    <div class="buttons">
                        <button id="clearPoints" class="secondary-btn">æ¸…é™¤æ‰€æœ‰ç‚¹</button>
                        <button id="calculateBtn" class="primary-btn">è®¡ç®—ç°åº¦å€¼</button>
                        <button id="exampleBtn" class="secondary-btn">åŠ è½½ç¤ºä¾‹å›¾åƒ</button>
                        <button id="testBtn" class="secondary-btn">æµ‹è¯•ç°åº¦è®¡ç®—</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="control-section">
                    <h2 class="section-title">3. åˆ†æç»“æœ</h2>

                    <div class="results-header">
                        <h3>ç°åº¦åˆ†æç»Ÿè®¡</h3>
                        <div id="pointsCount">å·²é€‰æ‹©ç‚¹: 0</div>
                    </div>

                    <div class="stats-summary">
                        <div class="stat-box">
                            <div class="stat-value" id="avgGrayValue">0</div>
                            <div class="stat-label">å¹³å‡ç°åº¦å€¼</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="maxDiffValue">0%</div>
                            <div class="stat-label">æœ€å¤§æµ®åŠ¨å·®å¼‚</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="inRangeValue">0</div>
                            <div class="stat-label">åœ¨é˜ˆå€¼èŒƒå›´å†…</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="outRangeValue">0</div>
                            <div class="stat-label">è¶…å‡ºé˜ˆå€¼èŒƒå›´</div>
                        </div>
                    </div>

                    <div class="points-table-container">
                        <table id="pointsTable">
                            <thead>
                                <tr>
                                    <th>ç‚¹</th>
                                    <th>åæ ‡(åŸå§‹)</th>
                                    <th>åæ ‡(æ˜¾ç¤º)</th>
                                    <th>ç°åº¦å€¼</th>
                                    <th>æµ®åŠ¨å·®å¼‚</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="pointsTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; color: #999; padding: 30px;">
                                        å°šæœªé€‰æ‹©åˆ†æç‚¹ï¼Œè¯·åœ¨å›¾åƒä¸Šç‚¹å‡»é€‰æ‹©ç‚¹
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 25px; padding: 15px; background-color: #f0f7ff; border-radius: 6px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">ä½¿ç”¨è¯´æ˜</h4>
                        <ol style="color: #555; padding-left: 20px; line-height: 1.8;">
                            <li>ä¸Šä¼ å›¾åƒæˆ–ä½¿ç”¨ç¤ºä¾‹å›¾åƒ</li>
                            <li><strong>æ³¨æ„ï¼š</strong>ç‚¹å‡»ä½ç½®ä¼šè‡ªåŠ¨æ˜ å°„åˆ°åŸå§‹å›¾åƒåæ ‡</li>
                            <li>åœ¨å›¾åƒä¸Šç‚¹å‡»é€‰æ‹©è¦åˆ†æçš„ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰</li>
                            <li>è°ƒæ•´é‡‡æ ·åŠå¾„å’Œæµ®åŠ¨é˜ˆå€¼</li>
                            <li>ç‚¹å‡»"è®¡ç®—ç°åº¦å€¼"æŒ‰é’®è¿›è¡Œåˆ†æ</li>
                            <li>æŸ¥çœ‹æ¯ä¸ªç‚¹çš„ç°åº¦å€¼ã€ä¸å¹³å‡å€¼çš„å·®å¼‚ä»¥åŠæ˜¯å¦åœ¨é˜ˆå€¼èŒƒå›´å†…</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>å›¾åƒç°åº¦åˆ†æå·¥å…· - ä¿®å¤ç‰ˆ &copy; 2023 | ä¿®å¤äº†åæ ‡æ˜ å°„å’Œç°åº¦è®¡ç®—é—®é¢˜</p>
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let image = null;
        let canvas = null;
        let ctx = null;
        let points = [];
        let isImageLoaded = false;
        let originalWidth = 0;
        let originalHeight = 0;
        let scaleX = 1;
        let scaleY = 1;

        // DOMå…ƒç´ 
        const imageInput = document.getElementById('imageInput');
        const uploadArea = document.getElementById('uploadArea');
        const imageCanvas = document.getElementById('imageCanvas');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const clearPointsBtn = document.getElementById('clearPoints');
        const calculateBtn = document.getElementById('calculateBtn');
        const exampleBtn = document.getElementById('exampleBtn');
        const testBtn = document.getElementById('testBtn');
        const sampleRadiusInput = document.getElementById('sampleRadius');
        const thresholdInput = document.getElementById('threshold');
        const pointsCount = document.getElementById('pointsCount');
        const avgGrayValue = document.getElementById('avgGrayValue');
        const maxDiffValue = document.getElementById('maxDiffValue');
        const inRangeValue = document.getElementById('inRangeValue');
        const outRangeValue = document.getElementById('outRangeValue');
        const pointsTableBody = document.getElementById('pointsTableBody');
        const debugInfo = document.getElementById('debugInfo');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            canvas = imageCanvas;
            ctx = canvas.getContext('2d', { willReadFrequently: true });

            // äº‹ä»¶ç›‘å¬å™¨
            uploadArea.addEventListener('click', () => imageInput.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            imageInput.addEventListener('change', handleImageUpload);
            clearPointsBtn.addEventListener('click', clearPoints);
            calculateBtn.addEventListener('click', calculateGrayValues);
            exampleBtn.addEventListener('click', loadExampleImage);
            testBtn.addEventListener('click', testGrayCalculation);
            canvas.addEventListener('click', handleCanvasClick);

            // åˆå§‹æ›´æ–°
            updatePointsCount();
        });

        // å¤„ç†æ‹–æ”¾
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.backgroundColor = '#f0ebff';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.style.backgroundColor = '#f9f6ff';

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                loadImageFromFile(files[0]);
            }
        }

        // å¤„ç†å›¾åƒä¸Šä¼ 
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImageFromFile(file);
            }
        }

        // ä»æ–‡ä»¶åŠ è½½å›¾åƒ
        function loadImageFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    setupCanvasWithImage(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // åŠ è½½ç¤ºä¾‹å›¾åƒ
        function loadExampleImage() {
            const img = new Image();
            img.onload = function() {
                setupCanvasWithImage(img);
            };
            img.crossOrigin = "anonymous";
            // ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾åƒ
            img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CiAgICAgIDxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMDAwMDAiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIyNSUiIHN0b3AtY29sb3I9IiM0NDQ0NDQiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI1MCUiIHN0b3AtY29sb3I9IiM4ODg4ODgiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSI3NSUiIHN0b3AtY29sb3I9IiNGRkZGRkYiLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMDAwMDAwIi8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyYWQpIi8+Cjwvc3ZnPg==';
        }

        // è®¾ç½®ç”»å¸ƒå’Œå›¾åƒ
        function setupCanvasWithImage(img) {
            image = img;
            isImageLoaded = true;
            originalWidth = img.width;
            originalHeight = img.height;

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            const container = canvas.parentElement;
            const maxWidth = container.clientWidth - 10;
            const maxHeight = 400;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä¿æŒå®½é«˜æ¯”
            let width = img.width;
            let height = img.height;

            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width = Math.floor(width * ratio);
                height = Math.floor(height * ratio);
            }

            canvas.width = width;
            canvas.height = height;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆç”¨äºåæ ‡æ˜ å°„ï¼‰
            scaleX = originalWidth / width;
            scaleY = originalHeight / height;

            // ç»˜åˆ¶å›¾åƒ
            ctx.clearRect(0, 0, width, height);
            ctx.drawImage(img, 0, 0, width, height);

            // éšè—å ä½ç¬¦
            imagePlaceholder.style.display = 'none';
            canvas.style.display = 'block';

            // æ›´æ–°è°ƒè¯•ä¿¡æ¯
            updateDebugInfo();

            // æ¸…é™¤ä¹‹å‰çš„ç‚¹
            clearPoints();

            // åœ¨ç¤ºä¾‹å›¾åƒä¸Šæ·»åŠ ä¸€äº›æµ‹è¯•ç‚¹
            if (img.src.includes('data:image/svg+xml')) {
                // ç­‰å¾…å›¾åƒå®Œå…¨æ¸²æŸ“
                setTimeout(() => {
                    // æ·»åŠ ä¸€äº›å·²çŸ¥ç°åº¦å€¼çš„æµ‹è¯•ç‚¹
                    addPointToCanvas(width * 0.2, height * 0.5);  // æš—è‰²åŒºåŸŸ
                    addPointToCanvas(width * 0.5, height * 0.5);  // ä¸­é—´ç°åº¦
                    addPointToCanvas(width * 0.8, height * 0.5);  // äº®è‰²åŒºåŸŸ
                    updatePointsDisplay();
                }, 100);
            }
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo() {
            if (image) {
                debugInfo.textContent = `ç”»å¸ƒå°ºå¯¸: ${canvas.width}Ã—${canvas.height} | å›¾åƒåŸå§‹å°ºå¯¸: ${originalWidth}Ã—${originalHeight} | ç¼©æ”¾æ¯”ä¾‹: X=${scaleX.toFixed(2)}, Y=${scaleY.toFixed(2)}`;
            }
        }

        // å¤„ç†ç”»å¸ƒç‚¹å‡»
        function handleCanvasClick(e) {
            if (!isImageLoaded) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨ç°æœ‰ç‚¹ä¸Š
            const clickedPointIndex = points.findIndex(point => {
                // ä½¿ç”¨æ˜¾ç¤ºåæ ‡æ£€æŸ¥
                const displayX = point.originalX / scaleX;
                const displayY = point.originalY / scaleY;
                const distance = Math.sqrt(Math.pow(displayX - x, 2) + Math.pow(displayY - y, 2));
                return distance < 15; // ç‚¹å‡»åŠå¾„ä¸º15åƒç´ 
            });

            if (clickedPointIndex !== -1) {
                // å¦‚æœç‚¹å‡»åœ¨ç°æœ‰ç‚¹ä¸Šï¼Œç§»é™¤è¯¥ç‚¹
                points.splice(clickedPointIndex, 1);
                updatePointsDisplay();
                updatePointsCount();
                return;
            }

            // æ·»åŠ æ–°ç‚¹
            addPointToCanvas(x, y);
        }

        // åœ¨ç”»å¸ƒåæ ‡ä¸Šæ·»åŠ ç‚¹
        function addPointToCanvas(canvasX, canvasY) {
            // è®¡ç®—åŸå§‹å›¾åƒåæ ‡
            const originalX = Math.round(canvasX * scaleX);
            const originalY = Math.round(canvasY * scaleY);

            // ç¡®ä¿åæ ‡åœ¨å›¾åƒèŒƒå›´å†…
            if (originalX < 0 || originalX >= originalWidth || originalY < 0 || originalY >= originalHeight) {
                console.warn('ç‚¹å‡»ä½ç½®è¶…å‡ºå›¾åƒèŒƒå›´');
                return;
            }

            points.push({
                canvasX: Math.round(canvasX),
                canvasY: Math.round(canvasY),
                originalX: originalX,
                originalY: originalY,
                grayValue: null,
                diffPercent: null,
                inRange: null
            });

            updatePointsDisplay();
            updatePointsCount();
        }

        // æ›´æ–°ç‚¹æ˜¾ç¤º
        function updatePointsDisplay() {
            if (!isImageLoaded) return;

            // æ¸…é™¤ç”»å¸ƒå¹¶é‡æ–°ç»˜åˆ¶å›¾åƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(image, 0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶æ‰€æœ‰ç‚¹
            points.forEach((point, index) => {
                // ä½¿ç”¨æ˜¾ç¤ºåæ ‡ç»˜åˆ¶
                const displayX = point.canvasX;
                const displayY = point.canvasY;

                // ç»˜åˆ¶ç‚¹æ ‡è®°
                ctx.beginPath();
                ctx.arc(displayX, displayY, 10, 0, Math.PI * 2);
                ctx.fillStyle = point.inRange === false ? '#ff6b6b' : '#6a11cb';
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'white';
                ctx.stroke();

                // ç»˜åˆ¶ç‚¹æ ‡ç­¾
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(displayX + 12, displayY - 25, 35, 22);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${index + 1}`, displayX + 30, displayY - 14);

                // ç»˜åˆ¶åæ ‡æ–‡æœ¬
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.font = '12px Arial';
                ctx.fillText(`(${point.originalX},${point.originalY})`, displayX, displayY + 25);
            });

            updatePointsCount();
        }

        // æ›´æ–°ç‚¹æ•°æ˜¾ç¤º
        function updatePointsCount() {
            pointsCount.textContent = `å·²é€‰æ‹©ç‚¹: ${points.length}`;
        }

        // æ¸…é™¤æ‰€æœ‰ç‚¹
        function clearPoints() {
            points = [];
            updatePointsDisplay();
            clearResults();
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            pointsTableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: #999; padding: 30px;">
                        å°šæœªé€‰æ‹©åˆ†æç‚¹ï¼Œè¯·åœ¨å›¾åƒä¸Šç‚¹å‡»é€‰æ‹©ç‚¹
                    </td>
                </tr>
            `;

            avgGrayValue.textContent = '0';
            maxDiffValue.textContent = '0%';
            inRangeValue.textContent = '0';
            outRangeValue.textContent = '0';
        }

        // æµ‹è¯•ç°åº¦è®¡ç®—
        function testGrayCalculation() {
            if (!isImageLoaded) {
                alert('è¯·å…ˆåŠ è½½å›¾åƒï¼');
                return;
            }

            // åˆ›å»ºæµ‹è¯•å›¾åƒ
            const testCanvas = document.createElement('canvas');
            testCanvas.width = 3;
            testCanvas.height = 1;
            const testCtx = testCanvas.getContext('2d');

            // ç»˜åˆ¶å·²çŸ¥é¢œè‰²çš„åƒç´ 
            const imageData = testCtx.createImageData(3, 1);

            // çº¢è‰² (R=255, G=0, B=0)
            imageData.data[0] = 255; // R
            imageData.data[1] = 0;   // G
            imageData.data[2] = 0;   // B
            imageData.data[3] = 255; // A

            // ç»¿è‰² (R=0, G=255, B=0)
            imageData.data[4] = 0;   // R
            imageData.data[5] = 255; // G
            imageData.data[6] = 0;   // B
            imageData.data[7] = 255; // A

            // è“è‰² (R=0, G=0, B=255)
            imageData.data[8] = 0;   // R
            imageData.data[9] = 0;   // G
            imageData.data[10] = 255; // B
            imageData.data[11] = 255; // A

            testCtx.putImageData(imageData, 0, 0);

            // è®¡ç®—ç°åº¦å€¼
            const gray1 = calculatePixelGray(0, 0, testCanvas, testCtx);
            const gray2 = calculatePixelGray(1, 0, testCanvas, testCtx);
            const gray3 = calculatePixelGray(2, 0, testCanvas, testCtx);

            alert(`ç°åº¦è®¡ç®—æµ‹è¯•ï¼š
çº¢è‰²(255,0,0)çš„ç°åº¦å€¼: ${gray1.toFixed(2)}
ç»¿è‰²(0,255,0)çš„ç°åº¦å€¼: ${gray2.toFixed(2)}
è“è‰²(0,0,255)çš„ç°åº¦å€¼: ${gray3.toFixed(2)}

è®¡ç®—å…¬å¼: Gray = 0.299*R + 0.587*G + 0.114*B`);
        }

        // è®¡ç®—å•ä¸ªåƒç´ çš„ç°åº¦å€¼
        function calculatePixelGray(x, y, canvasElement, context) {
            const imageData = context.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const data = imageData.data;

            const index = (y * canvasElement.width + x) * 4;
            const r = data[index];
            const g = data[index + 1];
            const b = data[index + 2];

            // æ ‡å‡†ç°åº¦è®¡ç®—å…¬å¼
            return 0.299 * r + 0.587 * g + 0.114 * b;
        }

        // è®¡ç®—ç°åº¦å€¼
        function calculateGrayValues() {
            if (!isImageLoaded || points.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ å›¾åƒå¹¶é€‰æ‹©è‡³å°‘ä¸€ä¸ªç‚¹ï¼');
                return;
            }

            const radius = parseInt(sampleRadiusInput.value);
            const threshold = parseInt(thresholdInput.value);

            // åˆ›å»ºåŸå§‹å°ºå¯¸çš„ç¦»å±canvasç”¨äºå‡†ç¡®è®¡ç®—
            const offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = originalWidth;
            offscreenCanvas.height = originalHeight;
            const offscreenCtx = offscreenCanvas.getContext('2d');
            offscreenCtx.drawImage(image, 0, 0);

            // è®¡ç®—æ¯ä¸ªç‚¹çš„ç°åº¦å€¼
            points.forEach(point => {
                point.grayValue = calculateAverageGray(
                    point.originalX,
                    point.originalY,
                    radius,
                    offscreenCanvas,
                    offscreenCtx
                );
            });

            // è®¡ç®—å¹³å‡ç°åº¦å€¼
            const avgGray = points.reduce((sum, point) => sum + point.grayValue, 0) / points.length;

            // è®¡ç®—æ¯ä¸ªç‚¹çš„æµ®åŠ¨å·®å¼‚
            let maxDiff = 0;
            points.forEach(point => {
                // é¿å…é™¤ä»¥é›¶
                if (avgGray === 0) {
                    point.diffPercent = 0;
                } else {
                    point.diffPercent = ((point.grayValue - avgGray) / avgGray * 100);
                }
                point.diffPercent = Math.round(point.diffPercent * 10) / 10;

                // æ£€æŸ¥æ˜¯å¦åœ¨é˜ˆå€¼èŒƒå›´å†…
                point.inRange = Math.abs(point.diffPercent) <= threshold;

                // æ›´æ–°æœ€å¤§å·®å¼‚
                if (Math.abs(point.diffPercent) > maxDiff) {
                    maxDiff = Math.abs(point.diffPercent);
                }
            });

            // æ›´æ–°æ˜¾ç¤º
            updateResults(avgGray, maxDiff, threshold);
        }

        // è®¡ç®—æŒ‡å®šç‚¹å‘¨å›´åŒºåŸŸçš„å¹³å‡ç°åº¦
        function calculateAverageGray(x, y, radius, canvasElement, context) {
            // è·å–å›¾åƒæ•°æ®
            const imageData = context.getImageData(0, 0, canvasElement.width, canvasElement.height);
            const data = imageData.data;

            let totalGray = 0;
            let count = 0;

            // å¦‚æœåŠå¾„ä¸º0ï¼Œåªè®¡ç®—å•ä¸ªåƒç´ 
            if (radius === 0) {
                const gray = calculatePixelGray(x, y, canvasElement, context);
                return Math.round(gray);
            }

            // éå†é‡‡æ ·åŒºåŸŸ
            for (let dy = -radius; dy <= radius; dy++) {
                for (let dx = -radius; dx <= radius; dx++) {
                    const px = Math.round(x + dx);
                    const py = Math.round(y + dy);

                    // ç¡®ä¿ç‚¹åœ¨å›¾åƒèŒƒå›´å†…
                    if (px >= 0 && px < canvasElement.width && py >= 0 && py < canvasElement.height) {
                        const gray = calculatePixelGray(px, py, canvasElement, context);
                        totalGray += gray;
                        count++;
                    }
                }
            }

            // è¿”å›å¹³å‡ç°åº¦å€¼
            return Math.round(totalGray / count);
        }

        // æ›´æ–°ç»“æœ
        function updateResults(avgGray, maxDiff, threshold) {
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            avgGrayValue.textContent = Math.round(avgGray);
            maxDiffValue.textContent = maxDiff.toFixed(1) + '%';

            // è®¡ç®—åœ¨é˜ˆå€¼èŒƒå›´å†…å’Œè¶…å‡ºèŒƒå›´çš„ç‚¹çš„æ•°é‡
            const inRangeCount = points.filter(point => point.inRange).length;
            const outRangeCount = points.length - inRangeCount;

            inRangeValue.textContent = inRangeCount;
            outRangeValue.textContent = outRangeCount;

            // æ›´æ–°è¡¨æ ¼
            updatePointsTable(threshold);

            // æ›´æ–°ç‚¹æ˜¾ç¤ºï¼ˆæ ¹æ®æ˜¯å¦åœ¨é˜ˆå€¼èŒƒå›´å†…æ”¹å˜é¢œè‰²ï¼‰
            updatePointsDisplay();
        }

        // æ›´æ–°ç‚¹è¡¨æ ¼
        function updatePointsTable(threshold) {
            if (points.length === 0) {
                pointsTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #999; padding: 30px;">
                            å°šæœªé€‰æ‹©åˆ†æç‚¹ï¼Œè¯·åœ¨å›¾åƒä¸Šç‚¹å‡»é€‰æ‹©ç‚¹
                        </td>
                    </tr>
                `;
                return;
            }

            let tableHTML = '';
            points.forEach((point, index) => {
                const diffClass = point.inRange ? 'in-range' : 'out-of-range';
                const diffSign = point.diffPercent >= 0 ? '+' : '';
                const statusText = point.inRange ? 'åœ¨èŒƒå›´å†…' : 'è¶…å‡ºèŒƒå›´';
                const statusClass = point.inRange ? 'in-range' : 'out-of-range';

                tableHTML += `
                    <tr>
                        <td class="point-id">${index + 1}</td>
                        <td class="point-coords">(${point.originalX}, ${point.originalY})</td>
                        <td class="point-coords">(${point.canvasX}, ${point.canvasY})</td>
                        <td class="point-gray">${point.grayValue}</td>
                        <td class="point-diff ${diffClass}">${diffSign}${point.diffPercent}%</td>
                        <td class="${statusClass}">${statusText}</td>
                    </tr>
                `;
            });

            pointsTableBody.innerHTML = tableHTML;
        }
    </script>
</body>
</html>
